@using Microsoft.AspNetCore.Components.Web

<div class="position-relative w-100">
    <InputText @bind-Value="Value"
               class="@InputClass"
               placeholder="@Placeholder"
               @oninput="OnInput"
               autocomplete="off" />
    <div class="list-group position-absolute w-100" style="z-index:10;"
         hidden="@(SuggestList.Count == 0)">
        @foreach (var item in SuggestList)
        {
            <button type="button" class="list-group-item list-group-item-action"
                    @onclick="() => On候補選択(item)">
                @item.Name
            </button>
        }
    </div>
</div>

@code {
    [Parameter] public string Value { get; set; } = "";
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public string Placeholder { get; set; } = "";
    [Parameter] public string InputClass { get; set; } = "form-control";
    [Parameter] public int MinChars { get; set; } = 2;
    [Parameter] public Func<string, Task<List<SuggestModel>>>? FetchSuggestions { get; set; }
    [Parameter] public EventCallback<SuggestModel> OnSelect { get; set; }

    public class SuggestModel
    {
        public string Code { get; set; } = "";
        public string Name { get; set; } = "";
        public object? AddInfo { get; set; }
    }
    private List<SuggestModel> SuggestList { get; set; } = new();

    private CancellationTokenSource? debounceCts;

    private async Task OnInput(ChangeEventArgs e)
    {
        var input = e.Value?.ToString() ?? "";
        await ValueChanged.InvokeAsync(input);

        if (input.Length < MinChars)
        {
            SuggestList.Clear();
            StateHasChanged();
            return;
        }

        debounceCts?.Cancel();
        debounceCts = new CancellationTokenSource();
        var token = debounceCts.Token;

        try
        {
            await Task.Delay(300, token);
            if (!token.IsCancellationRequested && FetchSuggestions != null)
            {
                var result = await FetchSuggestions(input);
                SuggestList = result;
                StateHasChanged();
            }
            else
            {
                SuggestList.Clear();
                StateHasChanged();
            }
        }
        catch (TaskCanceledException)
        {
            // 無視
        }
    }

    private void On候補選択(SuggestModel item)
    {
        OnSelect.InvokeAsync(item);
        SuggestList.Clear();
        StateHasChanged();
    }

}
